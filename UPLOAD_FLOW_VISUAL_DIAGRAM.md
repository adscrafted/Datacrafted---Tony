# Upload Flow Visual Diagram

## Complete State Transition Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                               â”‚
â”‚                            LANDING PAGE                                       â”‚
â”‚                          (app/page.tsx)                                       â”‚
â”‚                                                                               â”‚
â”‚  State:                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ useDataStore {                                                  â”‚        â”‚
â”‚  â”‚   fileName: null                                                â”‚        â”‚
â”‚  â”‚   rawData: []                                                   â”‚        â”‚
â”‚  â”‚   dataSchema: null                                              â”‚        â”‚
â”‚  â”‚   analysis: null                                                â”‚        â”‚
â”‚  â”‚   isAnalyzing: false                                            â”‚        â”‚
â”‚  â”‚   uploadComplete: false                                         â”‚        â”‚
â”‚  â”‚   uploadProjectId: null                                         â”‚        â”‚
â”‚  â”‚ }                                                               â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ User drops/selects file
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                               â”‚
â”‚                     FILE UPLOAD COMPONENT                                     â”‚
â”‚              (components/upload/file-upload-core.tsx)                         â”‚
â”‚                                                                               â”‚
â”‚  onDrop() â†’ handleFileProcessing()                                            â”‚
â”‚                                                                               â”‚
â”‚  Step 1: Initialize                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ setIsAnalyzing(true)           â† Triggers loading UI            â”‚        â”‚
â”‚  â”‚ setFileName('data.csv')                                         â”‚        â”‚
â”‚  â”‚ setUploadStage('uploading')                                     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚                                         â”‚
â”‚  Step 2: Parse File                 â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ parseFileOptimized(file)                                        â”‚        â”‚
â”‚  â”‚ - Reads CSV/Excel                                               â”‚        â”‚
â”‚  â”‚ - Converts to DataRow[]                                         â”‚        â”‚
â”‚  â”‚ - Progress: 0% â†’ 50%                                            â”‚        â”‚
â”‚  â”‚ setUploadStage('parsing')                                       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚                                         â”‚
â”‚  Step 3: Store Data                 â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ await setRawData(result.data)   â† CRITICAL: Async operation    â”‚        â”‚
â”‚  â”‚ - Stores in memory if < 1000 rows                              â”‚        â”‚
â”‚  â”‚ - Stores in IndexedDB if > 1000 rows                           â”‚        â”‚
â”‚  â”‚ - Updates dataId reference                                      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚                                         â”‚
â”‚  Step 4: Analyze Schema             â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ analyzeDataSchema(data, fileName, file)                         â”‚        â”‚
â”‚  â”‚ - Detects column types                                          â”‚        â”‚
â”‚  â”‚ - Calculates statistics                                         â”‚        â”‚
â”‚  â”‚ - Generates schema metadata                                     â”‚        â”‚
â”‚  â”‚ setDataSchema(schema)                                           â”‚        â”‚
â”‚  â”‚ setUploadStage('analyzing')                                     â”‚        â”‚
â”‚  â”‚ Progress: 50% â†’ 90%                                             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚                                         â”‚
â”‚  Step 5: Complete                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ setUploadStage('saving')                                        â”‚        â”‚
â”‚  â”‚ setIsAnalyzing(false)                                           â”‚        â”‚
â”‚  â”‚ setUploadProgress(100)                                          â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ setTimeout(500ms) â†’ onUploadComplete(rawData)                  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â”‚  State After Upload:                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ useDataStore {                                                  â”‚        â”‚
â”‚  â”‚   fileName: 'data.csv'                    âœ“ Set                â”‚        â”‚
â”‚  â”‚   rawData: [1000 rows]                    âœ“ Set                â”‚        â”‚
â”‚  â”‚   dataSchema: { columns, stats }          âœ“ Set                â”‚        â”‚
â”‚  â”‚   analysis: null                          âœ— Not set yet        â”‚        â”‚
â”‚  â”‚   isAnalyzing: false                                            â”‚        â”‚
â”‚  â”‚   uploadComplete: false                   âœ— Not set yet        â”‚        â”‚
â”‚  â”‚   uploadProjectId: null                   âœ— Not set yet        â”‚        â”‚
â”‚  â”‚ }                                                               â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ onUploadComplete callback
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                               â”‚
â”‚                    UPLOAD COMPLETE HANDLER                                    â”‚
â”‚                    (app/page.tsx - Line 51-100)                               â”‚
â”‚                                                                               â”‚
â”‚  handleUploadComplete(data)                                                   â”‚
â”‚                                                                               â”‚
â”‚  Step 1: Get Current State                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ const currentState = useDataStore.getState()                    â”‚        â”‚
â”‚  â”‚ console.log('fileName:', currentState.fileName)                 â”‚        â”‚
â”‚  â”‚ console.log('rawData length:', currentState.rawData.length)     â”‚        â”‚
â”‚  â”‚ console.log('hasSchema:', !!currentState.dataSchema)            â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚                                         â”‚
â”‚  Step 2: Create Project             â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ const project = await createProject({                           â”‚        â”‚
â”‚  â”‚   userId: user?.uid || 'anonymous',                             â”‚        â”‚
â”‚  â”‚   name: currentState.fileName,                                  â”‚        â”‚
â”‚  â”‚   description: 'Data analysis project...',                      â”‚        â”‚
â”‚  â”‚   fileInfo: { fileName, fileSize, rowCount, columnCount }       â”‚        â”‚
â”‚  â”‚ })                                                              â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ This calls useProjectStore.createProject():                     â”‚        â”‚
â”‚  â”‚   1. Try POST /api/projects (with auth token)                  â”‚        â”‚
â”‚  â”‚   2. If authenticated and API succeeds â†’ returns project        â”‚        â”‚
â”‚  â”‚   3. If fails â†’ creates local project with generated ID         â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ console.log('âœ… Project created:', project.id)                  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚                                         â”‚
â”‚  Step 3: Save Project Data          â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ if (currentState.rawData && currentState.rawData.length > 0) {  â”‚        â”‚
â”‚  â”‚   await saveProjectData(                                        â”‚        â”‚
â”‚  â”‚     project.id,                                                 â”‚        â”‚
â”‚  â”‚     currentState.rawData,     â† Full dataset                   â”‚        â”‚
â”‚  â”‚     currentState.analysis,    â† null at this point             â”‚        â”‚
â”‚  â”‚     currentState.dataSchema   â† Schema metadata                â”‚        â”‚
â”‚  â”‚   )                                                             â”‚        â”‚
â”‚  â”‚ }                                                               â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ This calls useProjectStore.saveProjectData():                   â”‚        â”‚
â”‚  â”‚   1. Try POST /api/projects/{id}/data (with retry logic)       â”‚        â”‚
â”‚  â”‚   2. Save to IndexedDB as backup (always)                      â”‚        â”‚
â”‚  â”‚   3. Update project with dataStorageId reference               â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ console.log('âœ… Project data saved')                            â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚                                         â”‚
â”‚  Step 4: Trigger Navigation         â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ setUploadProjectId(project.id)   â† 'proj-1234567890-abc123'    â”‚        â”‚
â”‚  â”‚ setUploadComplete(true)          â† Triggers status bar         â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ console.log('âœ… Upload complete, status bar will navigate')     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â”‚  State After Handler:                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ useDataStore {                                                        â”‚  â”‚
â”‚  â”‚   fileName: 'data.csv'                                                â”‚  â”‚
â”‚  â”‚   rawData: [1000 rows]                                                â”‚  â”‚
â”‚  â”‚   dataSchema: { columns, stats }                                      â”‚  â”‚
â”‚  â”‚   analysis: null                          Still null                  â”‚  â”‚
â”‚  â”‚   uploadComplete: true                    âœ“ Navigation trigger        â”‚  â”‚
â”‚  â”‚   uploadProjectId: 'proj-123'             âœ“ Navigation target         â”‚  â”‚
â”‚  â”‚ }                                                                     â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚ useProjectStore {                                                      â”‚  â”‚
â”‚  â”‚   projects: [                                                          â”‚  â”‚
â”‚  â”‚     {                                                                  â”‚  â”‚
â”‚  â”‚       id: 'proj-123',                                                  â”‚  â”‚
â”‚  â”‚       name: 'data.csv',                                                â”‚  â”‚
â”‚  â”‚       dataStorageId: 'storage-456',  â† IndexedDB reference            â”‚  â”‚
â”‚  â”‚       fileInfo: { rowCount, columnCount, ... }                         â”‚  â”‚
â”‚  â”‚     }                                                                  â”‚  â”‚
â”‚  â”‚   ]                                                                    â”‚  â”‚
â”‚  â”‚ }                                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ Upload status bar detects
                                     â”‚ uploadComplete && uploadProjectId
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                               â”‚
â”‚                      UPLOAD STATUS BAR                                        â”‚
â”‚              (components/ui/upload-status-bar.tsx)                            â”‚
â”‚                                                                               â”‚
â”‚  useEffect watches: uploadComplete && uploadProjectId                        â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ useEffect(() => {                                               â”‚        â”‚
â”‚  â”‚   if (uploadComplete && uploadProjectId) {                      â”‚        â”‚
â”‚  â”‚     // Mark all stages as complete                              â”‚        â”‚
â”‚  â”‚     setStages(prev => prev.map(s => ({                          â”‚        â”‚
â”‚  â”‚       ...s, status: 'complete'                                  â”‚        â”‚
â”‚  â”‚     })))                                                         â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚     // Wait 1500ms, then navigate                               â”‚        â”‚
â”‚  â”‚     const timer = setTimeout(() => {                            â”‚        â”‚
â”‚  â”‚       router.push(`/dashboard?id=${uploadProjectId}`)           â”‚        â”‚
â”‚  â”‚       setIsVisible(false)                                       â”‚        â”‚
â”‚  â”‚       dismissUpload()    â† âš ï¸ CLEARS STATE!                    â”‚        â”‚
â”‚  â”‚     }, 1500)                                                    â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚     return () => clearTimeout(timer)                            â”‚        â”‚
â”‚  â”‚   }                                                             â”‚        â”‚
â”‚  â”‚ }, [uploadComplete, uploadProjectId, router, dismissUpload])   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â”‚  Timeline:                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ T=0ms:    uploadComplete=true, uploadProjectId='proj-123'      â”‚        â”‚
â”‚  â”‚ T=0ms:    Stages marked as complete, UI shows checkmarks        â”‚        â”‚
â”‚  â”‚ T=1500ms: router.push('/dashboard?id=proj-123') executed       â”‚        â”‚
â”‚  â”‚ T=1500ms: dismissUpload() called immediately after              â”‚        â”‚
â”‚  â”‚           â†“                                                     â”‚        â”‚
â”‚  â”‚           Sets: uploadProjectId = null                          â”‚        â”‚
â”‚  â”‚                 uploadComplete = false                          â”‚        â”‚
â”‚  â”‚                 uploadProgress = 0                              â”‚        â”‚
â”‚  â”‚                 uploadStage = null                              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â”‚  âš ï¸ CRITICAL ISSUE:                                                          â”‚
â”‚  State is cleared BEFORE dashboard component mounts and loads data!          â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ Router navigates
                                     â”‚ URL: /dashboard?id=proj-123
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                               â”‚
â”‚                         DASHBOARD PAGE                                        â”‚
â”‚                    (app/dashboard/page.tsx)                                   â”‚
â”‚                                                                               â”‚
â”‚  URL Parameters:                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ const searchParams = useSearchParams()                          â”‚        â”‚
â”‚  â”‚ const sessionId = searchParams.get('session')    â†’ null         â”‚        â”‚
â”‚  â”‚ const projectId = searchParams.get('project')    â†’ null         â”‚        â”‚
â”‚  â”‚ const directId = searchParams.get('id')          â†’ 'proj-123'   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â”‚  Initial Store State (after dismissUpload):                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ useDataStore {                                                  â”‚        â”‚
â”‚  â”‚   fileName: 'data.csv'                Still in memory           â”‚        â”‚
â”‚  â”‚   rawData: [1000 rows]                Still in memory           â”‚        â”‚
â”‚  â”‚   dataSchema: { columns, stats }      Still in memory           â”‚        â”‚
â”‚  â”‚   analysis: null                                                â”‚        â”‚
â”‚  â”‚   uploadComplete: false               â† Cleared by dismissUploadâ”‚        â”‚
â”‚  â”‚   uploadProjectId: null               â† Cleared by dismissUploadâ”‚        â”‚
â”‚  â”‚   isLoadingFromAPI: false                                       â”‚        â”‚
â”‚  â”‚   isAnalyzing: false                                            â”‚        â”‚
â”‚  â”‚ }                                                               â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â”‚  Step 1: Check Routing Logic           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ useEffect(() => {                                               â”‚        â”‚
â”‚  â”‚   // Old project routing - not triggered                        â”‚        â”‚
â”‚  â”‚   if (projectId) {                                              â”‚        â”‚
â”‚  â”‚     router.replace(`/projects/${projectId}`)                    â”‚        â”‚
â”‚  â”‚     return                                                      â”‚        â”‚
â”‚  â”‚   }                                                             â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚   // No parameters at all - not triggered (we have directId)    â”‚        â”‚
â”‚  â”‚   if (!sessionId && !projectId && !directId) {                  â”‚        â”‚
â”‚  â”‚     const storeData = useDataStore.getState()                   â”‚        â”‚
â”‚  â”‚     if (!storeData.rawData || storeData.rawData.length === 0) {â”‚        â”‚
â”‚  â”‚       router.replace('/')                                       â”‚        â”‚
â”‚  â”‚       return                                                    â”‚        â”‚
â”‚  â”‚     }                                                           â”‚        â”‚
â”‚  â”‚   }                                                             â”‚        â”‚
â”‚  â”‚ }, [projectId, sessionId, directId, router])                   â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ âœ“ Passes - directId exists, continue to load data              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â”‚  Step 2: Load Data from API            â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ useEffect(() => {                                               â”‚        â”‚
â”‚  â”‚   // Handle directId from upload flow                           â”‚        â”‚
â”‚  â”‚   if (directId && loadedProjectIdRef.current !== directId) {   â”‚        â”‚
â”‚  â”‚     console.log('Loading project data from directId:', directId)â”‚        â”‚
â”‚  â”‚     loadedProjectIdRef.current = directId  // Mark as loading   â”‚        â”‚
â”‚  â”‚     setIsLoadingFromAPI(true)              // Show loading UI   â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚     const loadFromAPI = async () => {                           â”‚        â”‚
â”‚  â”‚       try {                                                     â”‚        â”‚
â”‚  â”‚         const token = await auth.currentUser?.getIdToken()     â”‚        â”‚
â”‚  â”‚         const response = await fetch(                           â”‚        â”‚
â”‚  â”‚           `/api/projects/${directId}/data`,                     â”‚        â”‚
â”‚  â”‚           { headers: { 'Authorization': `Bearer ${token}` } }   â”‚        â”‚
â”‚  â”‚         )                                                       â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚         if (!response.ok) {                                     â”‚        â”‚
â”‚  â”‚           throw new Error('Failed to load project data')        â”‚        â”‚
â”‚  â”‚         }                                                       â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚         const projectData = await response.json()               â”‚        â”‚
â”‚  â”‚         console.log('Project data loaded:', {                   â”‚        â”‚
â”‚  â”‚           hasData: !!projectData.data,                          â”‚        â”‚
â”‚  â”‚           dataLength: projectData.data?.length,                 â”‚        â”‚
â”‚  â”‚           hasAnalysis: !!projectData.analysis                   â”‚        â”‚
â”‚  â”‚         })                                                      â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚         // Update store with API data                           â”‚        â”‚
â”‚  â”‚         setFileName(projectData.metadata?.name)                 â”‚        â”‚
â”‚  â”‚         await setRawData(projectData.data)                      â”‚        â”‚
â”‚  â”‚         setAnalysis(projectData.analysis)  // May be null       â”‚        â”‚
â”‚  â”‚         setDataSchema(projectData.schema)                       â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚       } catch (error) {                                         â”‚        â”‚
â”‚  â”‚         console.error('Failed to load from API:', error)        â”‚        â”‚
â”‚  â”‚         setError('Failed to load project data')                 â”‚        â”‚
â”‚  â”‚       } finally {                                               â”‚        â”‚
â”‚  â”‚         setIsLoadingFromAPI(false)                              â”‚        â”‚
â”‚  â”‚       }                                                         â”‚        â”‚
â”‚  â”‚     }                                                           â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚     loadFromAPI()                                               â”‚        â”‚
â”‚  â”‚   }                                                             â”‚        â”‚
â”‚  â”‚ }, [rawData, analysis, isAnalyzing, sessionId, ...])           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â”‚  Step 3: Trigger AI Analysis           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ // Same useEffect continues...                                  â”‚        â”‚
â”‚  â”‚ if (rawData && rawData.length > 0 && !analysis &&              â”‚        â”‚
â”‚  â”‚     !isAnalyzing && !analysisInitiatedRef.current) {            â”‚        â”‚
â”‚  â”‚   analysisInitiatedRef.current = true                           â”‚        â”‚
â”‚  â”‚   performAnalysis()  // AI analysis or fallback charts          â”‚        â”‚
â”‚  â”‚ }                                                               â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â”‚  Loading Screen Logic:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ const shouldShowLoading =                                       â”‚        â”‚
â”‚  â”‚   isLoadingFromAPI ||            // Loading from API            â”‚        â”‚
â”‚  â”‚   isAnalyzing ||                 // AI analysis running         â”‚        â”‚
â”‚  â”‚   (rawData && !analysis) ||      // Has data, no analysis yet   â”‚        â”‚
â”‚  â”‚   (fileName && !rawData) ||      // Has name, no data yet       â”‚        â”‚
â”‚  â”‚   (dataId && !rawData)           // Has IndexedDB ref, no data  â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ if (shouldShowLoading) {                                        â”‚        â”‚
â”‚  â”‚   return <LoadingScreen />                                      â”‚        â”‚
â”‚  â”‚ }                                                               â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ // Dashboard renders when all data is ready                     â”‚        â”‚
â”‚  â”‚ return <FlexibleDashboardLayout analysis={analysis} ... />      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â”‚  Final State (Dashboard Loaded):                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ useDataStore {                                                  â”‚        â”‚
â”‚  â”‚   fileName: 'data.csv'                                          â”‚        â”‚
â”‚  â”‚   rawData: [1000 rows]              âœ“ Loaded from API          â”‚        â”‚
â”‚  â”‚   dataSchema: { columns, stats }    âœ“ Loaded from API          â”‚        â”‚
â”‚  â”‚   analysis: { chartConfig, ... }    âœ“ Generated by AI or API   â”‚        â”‚
â”‚  â”‚   isLoadingFromAPI: false                                       â”‚        â”‚
â”‚  â”‚   isAnalyzing: false                                            â”‚        â”‚
â”‚  â”‚ }                                                               â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ ğŸ‰ Dashboard displays with charts and data                      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Critical Failure Points

### 1. State Cleared Before Dashboard Load

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIME: T+1500ms (Navigation Triggered)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  router.push('/dashboard?id=proj-123')  â† Navigation starts â”‚
â”‚  dismissUpload()                         â† State cleared    â”‚
â”‚                                                              â”‚
â”‚  Upload state cleared:                                       â”‚
â”‚    uploadProjectId: null                                     â”‚
â”‚    uploadComplete: false                                     â”‚
â”‚    uploadProgress: 0                                         â”‚
â”‚    uploadStage: null                                         â”‚
â”‚                                                              â”‚
â”‚  âš ï¸ Problem: Dashboard component hasn't mounted yet!        â”‚
â”‚  âš ï¸ If dashboard needs uploadProjectId, it's already gone   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIME: T+1600ms (Dashboard Mounts)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  const directId = searchParams.get('id')  â†’ 'proj-123' âœ“   â”‚
â”‚                                                              â”‚
â”‚  âœ“ Good: Dashboard reads from URL parameter, not store      â”‚
â”‚  âœ“ Good: directId is preserved in URL                       â”‚
â”‚  âœ“ Good: Data still in memory (rawData, dataSchema)         â”‚
â”‚                                                              â”‚
â”‚  Dashboard loads data via API using directId                 â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. Race Condition: Save vs Load

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upload Complete Handler (app/page.tsx)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  T+0ms:   await createProject()              [50ms]         â”‚
â”‚  T+50ms:  await saveProjectData()            [2000ms] â†â”€â”   â”‚
â”‚           â†‘ Async operation, takes time         â”‚       â”‚   â”‚
â”‚           â†“ to save large files                 â”‚       â”‚   â”‚
â”‚  T+100ms: setUploadProjectId()                  â”‚       â”‚   â”‚
â”‚  T+100ms: setUploadComplete(true)               â”‚       â”‚   â”‚
â”‚           â†“ Triggers navigation immediately     â”‚       â”‚   â”‚
â”‚  T+1600ms: Navigation to dashboard              â”‚       â”‚   â”‚
â”‚           â†“                                     â”‚       â”‚   â”‚
â”‚  T+1700ms: Dashboard calls API load             â”‚       â”‚   â”‚
â”‚           GET /api/projects/proj-123/data       â”‚       â”‚   â”‚
â”‚           â†“                                     â”‚       â”‚   â”‚
â”‚  T+1750ms: API returns 404 - Data not found! â”€â”€â”€â”˜       â”‚   â”‚
â”‚           â†‘ Save still in progress!                     â”‚   â”‚
â”‚  T+2050ms: Save completes (too late) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  âš ï¸ Problem: Load happened before save completed!           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Fix Required:**
```typescript
// BEFORE:
await saveProjectData(...)
setUploadComplete(true)  // â† Don't wait for save!

// AFTER:
await saveProjectData(...)  // â† Wait for save to complete!
// Verify save worked
const verifyResponse = await fetch(`/api/projects/${id}/data`)
if (verifyResponse.ok) {
  setUploadComplete(true)  // â† Only navigate when safe
}
```

---

### 3. No Error Handling on Save Failure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Scenario: API Save Fails                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  try {                                                       â”‚
â”‚    await saveProjectData(project.id, rawData, ...)           â”‚
â”‚  } catch (error) {                                           â”‚
â”‚    console.error('Save failed:', error)                      â”‚
â”‚    // âš ï¸ ERROR LOGGED BUT IGNORED!                          â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  // Code continues regardless of error                       â”‚
â”‚  setUploadProjectId(project.id)    â† Still sets ID          â”‚
â”‚  setUploadComplete(true)            â† Still navigates       â”‚
â”‚                                                              â”‚
â”‚  âš ï¸ Result: User navigates to dashboard with no data saved! â”‚
â”‚  âš ï¸ Dashboard tries to load non-existent data               â”‚
â”‚  âš ï¸ User sees error or empty dashboard                      â”‚
â”‚  âš ï¸ Data lost from memory after navigation                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Fix Required:**
```typescript
try {
  await saveProjectData(project.id, rawData, ...)
} catch (error) {
  console.error('Save failed:', error)
  setError('Failed to save your data. Please try again.')
  // DON'T navigate on error!
  return
}

// Only proceed if save succeeded
setUploadProjectId(project.id)
setUploadComplete(true)
```

---

## State Persistence Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Storage Locations                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. IN-MEMORY (useDataStore)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Lifetime: Current page session                                  â”‚
â”‚  Speed:    Instant (0ms)                                         â”‚
â”‚  Size:     Limited by available RAM                              â”‚
â”‚                                                                  â”‚
â”‚  Data:                                                           â”‚
â”‚  - rawData: DataRow[]         â† NOT persisted to localStorage   â”‚
â”‚  - fileName: string            â† Persisted                       â”‚
â”‚  - dataSchema: DataSchema      â† Persisted                       â”‚
â”‚  - analysis: AnalysisResult    â† Persisted                       â”‚
â”‚                                                                  â”‚
â”‚  âš ï¸ rawData lost on:                                            â”‚
â”‚    - Page refresh                                                â”‚
â”‚    - Navigation to different site                                â”‚
â”‚    - Tab close                                                   â”‚
â”‚    - Browser crash                                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼ setRawData() if > 1000 rows
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. INDEXEDDB (Browser Local Storage)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Lifetime: Persistent until cleared                              â”‚
â”‚  Speed:    Fast (10-50ms)                                        â”‚
â”‚  Size:     ~50MB - 500MB (browser dependent)                     â”‚
â”‚                                                                  â”‚
â”‚  Database: 'datacrafted-project-data'                            â”‚
â”‚  Store:    'projectData'                                         â”‚
â”‚                                                                  â”‚
â”‚  Structure:                                                      â”‚
â”‚  {                                                               â”‚
â”‚    projectId: 'proj-123',                                        â”‚
â”‚    rawData: [...1000 rows...],                                   â”‚
â”‚    analysis: {...},                                              â”‚
â”‚    dataSchema: {...},                                            â”‚
â”‚    savedAt: '2025-10-14T10:30:00Z'                               â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  âœ“ Survives page refresh                                         â”‚
â”‚  âœ“ Survives navigation                                           â”‚
â”‚  âœ— Lost if browser storage cleared                              â”‚
â”‚  âœ— Lost if user switches browsers                               â”‚
â”‚  âœ— Not synced across devices                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼ saveProjectData()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. API/DATABASE (Server Persistent Storage)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Lifetime: Permanent (until deleted)                             â”‚
â”‚  Speed:    Network dependent (100-500ms)                         â”‚
â”‚  Size:     Unlimited (server storage)                            â”‚
â”‚                                                                  â”‚
â”‚  Endpoint: POST /api/projects/{projectId}/data                   â”‚
â”‚                                                                  â”‚
â”‚  Request:                                                        â”‚
â”‚  {                                                               â”‚
â”‚    data: [...full dataset...],                                   â”‚
â”‚    analysis: {...},                                              â”‚
â”‚    metadata: {                                                   â”‚
â”‚      fileName: 'data.csv',                                       â”‚
â”‚      fileSize: 1048576,                                          â”‚
â”‚      mimeType: 'text/csv'                                        â”‚
â”‚    }                                                             â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  Response:                                                       â”‚
â”‚  {                                                               â”‚
â”‚    id: 'data-storage-789',                                       â”‚
â”‚    version: 1,                                                   â”‚
â”‚    metadata: {                                                   â”‚
â”‚      rowCount: 1000,                                             â”‚
â”‚      columnCount: 15,                                            â”‚
â”‚      savedAt: '2025-10-14T10:30:05Z'                             â”‚
â”‚    }                                                             â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  âœ“ Survives everything                                           â”‚
â”‚  âœ“ Synced across devices                                         â”‚
â”‚  âœ“ Accessible from anywhere                                      â”‚
â”‚  âœ— Requires authentication                                       â”‚
â”‚  âœ— Requires network connection                                   â”‚
â”‚  âœ— Slower than local storage                                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Load Priority on Dashboard

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dashboard Data Load Sequence                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Check URL Parameter
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ const directId = searchParams.get('id')                â”‚
   â”‚                                                        â”‚
   â”‚ if (directId exists) {                                 â”‚
   â”‚   â†’ Proceed to Step 2                                  â”‚
   â”‚ } else {                                               â”‚
   â”‚   â†’ Check for data in store (Step 5)                   â”‚
   â”‚ }                                                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
2. Load from API (Primary)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ try {                                                  â”‚
   â”‚   GET /api/projects/{directId}/data                    â”‚
   â”‚                                                        â”‚
   â”‚   if (response.ok) {                                   â”‚
   â”‚     â†’ Use API data (AUTHORITATIVE)                     â”‚
   â”‚     â†’ Skip Steps 3-4                                   â”‚
   â”‚   } else {                                             â”‚
   â”‚     â†’ Proceed to Step 3 (fallback)                     â”‚
   â”‚   }                                                    â”‚
   â”‚ }                                                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
3. Load from useProjectStore (Secondary)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ const project = useProjectStore                        â”‚
   â”‚   .getProjectData(directId)                            â”‚
   â”‚                                                        â”‚
   â”‚ if (project?.debugData) {                              â”‚
   â”‚   â†’ Use localStorage cached data                       â”‚
   â”‚   â†’ Skip Step 4                                        â”‚
   â”‚ } else {                                               â”‚
   â”‚   â†’ Proceed to Step 4                                  â”‚
   â”‚ }                                                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
4. Load from IndexedDB (Tertiary)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ const projectData = await useProjectStore              â”‚
   â”‚   .loadProjectDataAsync(directId)                      â”‚
   â”‚                                                        â”‚
   â”‚ if (projectData) {                                     â”‚
   â”‚   â†’ Use IndexedDB data                                 â”‚
   â”‚ } else {                                               â”‚
   â”‚   â†’ No data found, show error                          â”‚
   â”‚ }                                                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
5. Check In-Memory Store (Last Resort)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ const storeData = useDataStore.getState()              â”‚
   â”‚                                                        â”‚
   â”‚ if (storeData.rawData && storeData.rawData.length > 0) â”‚
   â”‚   â†’ Use existing store data                            â”‚
   â”‚   â†’ Generate analysis if missing                       â”‚
   â”‚ } else {                                               â”‚
   â”‚   â†’ Redirect to landing page (no data available)       â”‚
   â”‚ }                                                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Recommended Timeline (Fixed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPLOAD COMPLETE HANDLER (Fixed Version)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚ T+0ms:    Start upload complete handler                   â”‚
â”‚ T+50ms:   Project created (local or API)                  â”‚
â”‚ T+100ms:  Start saveProjectData()                         â”‚
â”‚ T+2000ms: saveProjectData() completes â† WAIT HERE         â”‚
â”‚ T+2100ms: Verify data saved:                              â”‚
â”‚           GET /api/projects/{id}/data                     â”‚
â”‚ T+2200ms: Verification successful âœ“                       â”‚
â”‚ T+2200ms: setUploadProjectId()                            â”‚
â”‚ T+2200ms: setUploadComplete(true) â† ONLY NOW              â”‚
â”‚ T+3700ms: Navigation triggered (1500ms delay)             â”‚
â”‚ T+3800ms: Dashboard mounts                                â”‚
â”‚ T+3900ms: Dashboard loads data from API âœ“                 â”‚
â”‚                                                            â”‚
â”‚ âœ“ Data is guaranteed saved before navigation              â”‚
â”‚ âœ“ No race condition between save and load                 â”‚
â”‚ âœ“ Dashboard will always find data                         â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPLOAD STATUS BAR (Fixed Version)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚ T+3700ms: uploadComplete=true detected                    â”‚
â”‚ T+3700ms: Start 1500ms delay timer                        â”‚
â”‚ T+5200ms: Navigation: router.push('/dashboard?id=...')    â”‚
â”‚ T+5200ms: Hide status bar                                 â”‚
â”‚ T+7200ms: dismissUpload() â† DELAYED by 2000ms            â”‚
â”‚           â†‘ Dashboard has time to load first               â”‚
â”‚                                                            â”‚
â”‚ âœ“ State not cleared until dashboard has loaded            â”‚
â”‚ âœ“ Upload state available if dashboard needs it            â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
